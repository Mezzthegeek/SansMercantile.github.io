<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sans Mercantile - Admin Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel for JSX compilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts: Inter & Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Your actual Firebase project configuration is now included.
        const firebaseConfig = {
            apiKey: "AIzaSyCOFO_bhkY-BvWimABJh-RWf0q084XHVdU",
            authDomain: "sans-mercantile.firebaseapp.com",
            projectId: "sans-mercantile",
            storageBucket: "sans-mercantile.appspot.com",
            messagingSenderId: "829965275751",
            appId: "1:829965275751:web:c53395cceb69f6ba5d7ac2",
            measurementId: "G-FVEEDYCZFH"
        };
        
        window.firebaseConfig = firebaseConfig;
        window.appId = firebaseConfig.appId || 'default-app-id';
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --color-text-primary: #1f0000; /* burgundy-black */
            --color-accent-primary: #FC7642; /* orange */
            --color-bg-main: #f0f0f0; /* silver */
            --color-border-focus: #4b5563; /* A classy, darker gray for focus */
        }
        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
        }
        .btn-primary {
            background-color: var(--color-text-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #490c09; /* crimson-noir */
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .text-accent {
            color: var(--color-accent-primary);
        }
        .input-focus:focus {
            outline: none;
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 1px var(--color-border-focus);
        }
        .ql-editor {
            min-height: 350px;
            font-size: 16px;
        }
        .ql-toolbar {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .ql-container {
             border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, serverTimestamp, query, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const { useState, useEffect, useCallback, useRef } = React;

        let app, auth, db, storage;
        let firebaseError = null;
        try {
            if (window.firebaseConfig && window.firebaseConfig.apiKey) {
                app = initializeApp(window.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } else {
                throw new Error("Firebase configuration is missing or invalid.");
            }
        } catch (e) {
            console.error("Firebase initialization error:", e);
            firebaseError = e.message;
        }

        const Lock = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}> <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect> <path d="M7 11V7a5 5 0 0 1 10 0v4"></path> </svg> );
        const Mail = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}> <rect width="20" height="16" x="2" y="4" rx="2"></rect> <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path> </svg> );
        const User = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}> <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path> <circle cx="12" cy="7" r="4"></circle> </svg> );
        const Building = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}> <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect> <path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path> </svg> );
        const Sparkles = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9 1.9 5.8 1.9-5.8 5.8-1.9-5.8-1.9z"/></svg>);

        const WordLogo = ({ onDarkBg = false, className = '' }) => {
            const mercantileColor = onDarkBg ? 'var(--color-bg-main)' : 'var(--color-text-primary)';
            return (
                <div className={`font-display font-bold tracking-tight ${className}`}>
                    <span style={{ color: 'var(--color-accent-primary)' }}>Sans</span>
                    <span style={{ color: mercantileColor }}>
                        Mercantile<sup className="font-normal">&trade;</sup>
                    </span>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [view, setView] = useState('login');
            const [userType, setUserType] = useState('individual');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const PRIMARY_ADMIN_EMAIL = "hello@sansmercantile.com";

            useEffect(() => {
                if (!auth) {
                    setIsLoading(false);
                    return;
                };
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                const email = e.target.email.value;
                const password = e.target.password.value;
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    if (userCredential.user.email !== PRIMARY_ADMIN_EMAIL && !userCredential.user.emailVerified) {
                        setError("Please verify your email address. Check your inbox for a verification link.");
                        await signOut(auth);
                    }
                } catch (err) {
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
                        setError("Invalid credentials. Please check your email and password and try again.");
                    } else {
                        setError("An unexpected error occurred. Please try again later.");
                    }
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                const form = e.target;
                const email = form.email.value;
                const password = form.password.value;

                if (userType === 'individual') {
                    if (email === PRIMARY_ADMIN_EMAIL) {
                        try {
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            const userDocRef = doc(db, `artifacts/${window.appId}/users`, userCredential.user.uid);
                            await setDoc(userDocRef, {
                                fullName: "Primary Admin", email: userCredential.user.email, role: 'admin',
                                createdAt: serverTimestamp()
                            });
                            setSuccess("Primary admin account created successfully. You can now log in.");
                            await signOut(auth);
                            setView('login');
                        } catch (err) {
                            if (err.code === 'auth/email-already-in-use') {
                                setError("It appears that you are already a member of the team. Why don't you try signing in?");
                            } else {
                                setError("An unexpected error occurred during registration.");
                            }
                        }
                        return;
                    }

                    if (!email.endsWith('@sansmercantile.com')) {
                        setError('This is a restricted area.');
                        setTimeout(() => { window.location.href = "https://www.sansmercantile.com"; }, 2000);
                        return;
                    }
                    try {
                        const recordsRef = collection(db, `artifacts/${window.appId}/public/data/employee_records`);
                        const q = query(recordsRef, where("email", "==", email));
                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            setError("Your email is not registered. Please contact an administrator.");
                            return;
                        }

                        const employeeDoc = querySnapshot.docs[0];
                        if (employeeDoc.data().accountCreated) {
                            setError("It appears that you are already a member of the team. Why don't you try signing in?");
                            return;
                        }

                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await sendEmailVerification(userCredential.user);

                        const employeeData = employeeDoc.data();
                        const userProfile = {
                            fullName: employeeData.full_name, // FIX: Match Firestore field name
                            email: userCredential.user.email,
                            employeeId: employeeData.employee_id, // FIX: Match Firestore field name
                            nationalId: employeeData.national_id, // FIX: Match Firestore field name
                            designation: employeeData.designation,
                            createdAt: serverTimestamp(), userType: 'individual', status: 'active', role: 'editor'
                        };
                        const userDocRef = doc(db, `artifacts/${window.appId}/users`, userCredential.user.uid);
                        await setDoc(userDocRef, userProfile);
                        await updateDoc(employeeDoc.ref, { accountCreated: true });
                        setSuccess("Registration successful! A verification link has been sent to your email. Please verify before logging in.");
                        await signOut(auth);
                        setView('login');
                    } catch (err) {
                        if (err.code === 'auth/email-already-in-use') {
                            setError("It appears that you are already a member of the team. Why don't you try signing in?");
                        } else {
                            setError("An unexpected error occurred during registration. Please try again.");
                        }
                    }
                } else { // Organization signup
                    const personalDomains = ['gmail.com', 'outlook.com', 'yahoo.com', 'aol.com', 'hotmail.com', 'live.com', 'icloud.com'];
                    const domain = email.split('@')[1];

                    if (personalDomains.includes(domain)) {
                        setError('Please use a business email address for organization registration. Personal email domains are not permitted.');
                        return;
                    }
                    try {
                        const orgData = {
                            orgName: form.orgName.value, orgEmail: email, orgReg: form.orgReg.value,
                            contactPerson: form.contactPerson.value, status: 'pending', submittedAt: serverTimestamp()
                        };
                        const pendingRef = collection(db, `artifacts/${window.appId}/public/data/pendingApprovals`);
                        await addDoc(pendingRef, orgData);
                        setSuccess('Application submitted successfully. We will contact you upon review.');
                        setView('login');
                    } catch (err) {
                        setError("An unexpected error occurred during registration. Please try again.");
                    }
                }
            };

            const handleSignOut = async () => {
                await signOut(auth);
            }
            
            if (firebaseError) {
                return <div className="min-h-screen flex items-center justify-center text-red-500 font-bold p-8 text-center">{firebaseError}</div>
            }

            if (isLoading) {
                return <div className="min-h-screen flex items-center justify-center">Loading...</div>
            }

            const isVerified = user && (user.email === PRIMARY_ADMIN_EMAIL || user.emailVerified);
            if (user && isVerified) {
                return <Dashboard user={user} onSignOut={handleSignOut} />;
            }

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
                    <div className="w-full max-w-md space-y-8">
                        <div className="text-center">
                            <WordLogo className="text-4xl justify-center flex" />
                             <h2 className="mt-6 text-center text-2xl font-display text-gray-700">
                                {view === 'login' ? 'Portal Sign In' : 'Account Registration'}
                            </h2>
                        </div>
                        {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">{error}</div>}
                        {success && <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">{success}</div>}
                        {view === 'login' ? <LoginForm handleLogin={handleLogin} setView={setView} /> : <SignupForm handleSignup={handleSignup} setView={setView} userType={userType} setUserType={setUserType} />}
                    </div>
                </div>
            );
        }

        function LoginForm({ handleLogin, setView }) {
            return (
                <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                     <div className="rounded-md shadow-sm space-y-4">
                        <InputField id="email-address" name="email" type="email" placeholder="Email address" icon={Mail} />
                        <InputField id="password" name="password" type="password" placeholder="Password" icon={Lock} />
                    </div>
                    <div><button type="submit" className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md btn-primary transition-colors">Sign in</button></div>
                    <p className="mt-2 text-center text-sm text-gray-600">Need an account?{' '}<a href="#" onClick={(e) => { e.preventDefault(); setView('signup'); }} className="font-medium text-accent hover:underline">Register</a></p>
                </form>
            );
        }

        function SignupForm({ handleSignup, setView, userType, setUserType }) {
            return (
                <form className="mt-8 space-y-6" onSubmit={handleSignup}>
                    <div className="flex justify-center rounded-md border border-gray-300 p-1 bg-gray-200">
                        <button type="button" onClick={() => setUserType('individual')} className={`w-1/2 py-2 text-sm font-medium rounded-md ${userType === 'individual' ? 'bg-white text-accent shadow' : 'text-gray-600'}`}>Employee</button>
                        <button type="button" onClick={() => setUserType('organization')} className={`w-1/2 py-2 text-sm font-medium rounded-md ${userType === 'organization' ? 'bg-white text-accent shadow' : 'text-gray-600'}`}>Organization</button>
                    </div>
                    {userType === 'individual' ? <IndividualFields /> : <OrganizationFields />}
                    <div><button type="submit" className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md btn-primary transition-colors">Register</button></div>
                    <p className="mt-2 text-center text-sm text-gray-600">Already have an account?{' '}<a href="#" onClick={(e) => { e.preventDefault(); setView('login'); }} className="font-medium text-accent hover:underline">Sign In</a></p>
                </form>
            );
        }

        const InputField = ({ id, name, type, placeholder, icon: Icon, value, onChange, required = true }) => (
            <div className="relative">
                {Icon && <Icon className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />}
                <input id={id} name={name} type={type} required={required} value={value} onChange={onChange} className="appearance-none rounded-md relative block w-full px-3 py-3 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none input-focus sm:text-sm" placeholder={placeholder} />
            </div>
        );

        function IndividualFields() {
            return (
                <div className="space-y-4">
                    <InputField name="email" type="email" placeholder="Company Email" icon={Mail} />
                    <InputField name="password" type="password" placeholder="Create a Password" icon={Lock} />
                </div>
            );
        }

        function OrganizationFields() {
            return (
                <div className="space-y-4">
                    <InputField name="orgName" type="text" placeholder="Organization Name" icon={Building} />
                    <InputField name="email" type="email" placeholder="Business Email" icon={Mail} />
                    <InputField name="password" type="password" placeholder="Create a Password" icon={Lock} />
                    <InputField name="orgReg" type="text" placeholder="Company Registration Number" icon={Building} />
                    <InputField name="contactPerson" type="text" placeholder="Contact Person Name" icon={User} />
                </div>
            );
        }

        // --- Blog Components ---
        function AIAssistant({ quill, onApplySuggestion, onInsertImage }) {
            const [activeTab, setActiveTab] = useState('review');
            const [suggestions, setSuggestions] = useState([]);
            const [isReviewLoading, setReviewLoading] = useState(false);
            const [imagePrompt, setImagePrompt] = useState('');
            const [generatedImageUrl, setGeneratedImageUrl] = useState(null);
            const [isImageLoading, setImageLoading] = useState(false);
            const [error, setError] = useState('');

            const handleReviewText = async () => {
                if (!quill) return;
                setReviewLoading(true);
                setError('');
                setSuggestions([]);
                const text = quill.getText();

                const prompt = `You are an expert blog editor for a fintech company. Review the following blog post for clarity, grammar, and engagement. Provide a list of specific suggestions for improvement. For each suggestion, provide the original text to be replaced, the suggested new text, and a brief reason for the change. Respond in a structured JSON format. Here is the text: ${text}`;
                
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        originalText: { type: "STRING" },
                                        suggestedText: { type: "STRING" },
                                        reason: { type: "STRING" }
                                    },
                                    required: ["originalText", "suggestedText", "reason"]
                                }
                            }
                        }
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const parsedSuggestions = JSON.parse(result.candidates[0].content.parts[0].text);
                        setSuggestions(parsedSuggestions);
                    } else {
                        throw new Error("Failed to get suggestions from AI.");
                    }
                } catch (err) {
                    console.error("AI review failed:", err);
                    setError("Could not get suggestions. Please ensure the 'Generative Language API' is enabled in your Google Cloud project and try again.");
                } finally {
                    setReviewLoading(false);
                }
            };

            const handleGenerateImage = async () => {
                if (!imagePrompt) return;
                setImageLoading(true);
                setError('');
                setGeneratedImageUrl(null);
                
                try {
                    const payload = { instances: [{ prompt: imagePrompt }], parameters: { "sampleCount": 1 } };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        setGeneratedImageUrl(imageUrl);
                    } else {
                        throw new Error("Failed to generate image.");
                    }
                } catch (err) {
                    console.error("Image generation failed:", err);
                    setError("Could not generate image. Please ensure the 'Generative Language API' is enabled and try again.");
                } finally {
                    setImageLoading(false);
                }
            };

            return (
                <div className="bg-white p-4 rounded-lg shadow-md border w-full md:w-80">
                    <div className="flex items-center space-x-2 mb-4">
                        <Sparkles className="text-accent" />
                        <h3 className="text-lg font-display font-bold">AI Assistant</h3>
                    </div>
                    <div className="flex border-b mb-4">
                        <button onClick={() => setActiveTab('review')} className={`flex-1 py-2 text-sm font-semibold ${activeTab === 'review' ? 'border-b-2 border-accent text-accent' : 'text-gray-500'}`}>Review & Edit</button>
                        <button onClick={() => setActiveTab('image')} className={`flex-1 py-2 text-sm font-semibold ${activeTab === 'image' ? 'border-b-2 border-accent text-accent' : 'text-gray-500'}`}>Generate Image</button>
                    </div>

                    {activeTab === 'review' && (
                        <div>
                            <button onClick={handleReviewText} disabled={isReviewLoading} className="btn-primary w-full py-2 rounded-md text-sm font-semibold mb-4">
                                {isReviewLoading ? 'Analyzing...' : 'Review with AI'}
                            </button>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {suggestions.map((s, index) => (
                                    <div key={index} className="bg-gray-50 p-3 rounded-md border">
                                        <p className="text-xs text-gray-500">Suggestion:</p>
                                        <p className="text-sm font-semibold my-1">"{s.suggestedText}"</p>
                                        <p className="text-xs text-gray-600 italic mb-2">{s.reason}</p>
                                        <button onClick={() => onApplySuggestion(s)} className="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Apply</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'image' && (
                        <div className="space-y-4">
                            <textarea value={imagePrompt} onChange={(e) => setImagePrompt(e.target.value)} placeholder="Describe the image you want to create..." className="w-full p-2 border rounded-md text-sm h-24"></textarea>
                            <button onClick={handleGenerateImage} disabled={isImageLoading} className="btn-primary w-full py-2 rounded-md text-sm font-semibold">
                                {isImageLoading ? 'Generating...' : 'Generate Image'}
                            </button>
                            {isImageLoading && <div className="text-center text-sm text-gray-500">Creating image, please wait...</div>}
                            {generatedImageUrl && (
                                <div>
                                    <img src={generatedImageUrl} alt="AI generated" className="rounded-md border" />
                                    <button onClick={() => onInsertImage(generatedImageUrl)} className="bg-blue-500 text-white w-full mt-2 py-2 rounded-md text-sm font-semibold hover:bg-blue-600">Insert Image</button>
                                </div>
                            )}
                        </div>
                    )}
                    {error && <p className="text-red-500 text-xs mt-4">{error}</p>}
                </div>
            );
        }

        function BlogEditor({ post, onSave }) {
            const [title, setTitle] = useState(post?.title || '');
            const [content, setContent] = useState(post?.content || '');
            const [description, setDescription] = useState(post?.description || '');
            const [tags, setTags] = useState(post?.tags?.join(', ') || '');
            const [metaImage, setMetaImage] = useState(post?.metaImage || '');
            const [isSaving, setIsSaving] = useState(false);
            const quillRef = useRef();
            const formRef = useRef();

            const imageHandler = useCallback(() => { const input = document.createElement('input'); input.setAttribute('type', 'file'); input.setAttribute('accept', 'image/*'); input.click(); input.onchange = async () => { const file = input.files[0]; if (!file) return; const quill = quillRef.current; const range = quill.getSelection(true); quill.enable(false); try { const storageRef = ref(storage, `blogs/${Date.now()}_${file.name}`); const snapshot = await uploadBytes(storageRef, file); const url = await getDownloadURL(snapshot.ref); quill.enable(true); quill.insertEmbed(range.index, 'image', url); quill.setSelection(range.index + 1); } catch (error) { console.error("Image upload failed:", error); quill.enable(true); } }; }, []);

            useEffect(() => {
                if (quillRef.current) return;
                const editor = new Quill('#editor', { theme: 'snow', modules: { toolbar: { container: [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{'list': 'ordered'}, {'list': 'bullet'}], ['link', 'image', 'video'], ['clean'] ], handlers: { image: imageHandler } } } });
                quillRef.current = editor;
                if (content) {
                    editor.root.innerHTML = content;
                }
                editor.on('text-change', () => { setContent(editor.root.innerHTML); });
            }, [imageHandler, content]);

            const handleSave = async () => {
                setIsSaving(true);
                const tagsArray = tags.split(',').map(tag => tag.trim()).filter(Boolean);
                try {
                    await onSave({ ...post, title, content, description, tags: tagsArray, metaImage });
                } catch (error) {
                    console.error("Failed to save post:", error);
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handleApplySuggestion = (suggestion) => {
                const { originalText, suggestedText } = suggestion;
                const editor = quillRef.current;
                const currentText = editor.getText();
                const newText = currentText.replace(originalText, suggestedText);
                editor.setText(newText);
            };

            const handleInsertImage = (imageUrl) => {
                const editor = quillRef.current;
                const range = editor.getSelection(true);
                editor.insertEmbed(range.index, 'image', imageUrl);
            };

            return (
                <form ref={formRef} onSubmit={(e) => { e.preventDefault(); handleSave(); }}>
                    <div className="flex flex-col md:flex-row gap-6">
                        <div className="flex-grow space-y-4">
                            <input type="text" placeholder="Blog Title" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full p-3 text-2xl font-bold font-display border-b-2 focus:outline-none input-focus" required />
                            <textarea placeholder="SEO Description (max 160 characters)" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full p-3 text-sm border rounded-md focus:outline-none input-focus h-24 resize-none" maxLength="160"></textarea>
                            <input type="text" placeholder="Tags (comma-separated, e.g., AI, Fintech, Markets)" value={tags} onChange={(e) => setTags(e.target.value)} className="w-full p-3 text-sm border rounded-md focus:outline-none input-focus" />
                            <input type="url" placeholder="Featured Image URL (optional)" value={metaImage} onChange={(e) => setMetaImage(e.target.value)} className="w-full p-3 text-sm border rounded-md focus:outline-none input-focus" />
                            <div id="editor"></div>
                        </div>
                        <AIAssistant quill={quillRef.current} onApplySuggestion={handleApplySuggestion} onInsertImage={handleInsertImage} />
                    </div>
                     <div className="w-full flex justify-end space-x-4 pt-4">
                        <button type="button" onClick={() => window.location.hash = '#blog'} className="btn-secondary px-6 py-2 rounded-md font-semibold">Cancel</button>
                        <button type="submit" disabled={isSaving || title.trim() === ''} className="btn-primary px-6 py-2 rounded-md font-semibold">
                            {isSaving ? 'Saving...' : 'Submit for Review'}
                        </button>
                    </div>
                </form>
            );
        }
        
        // --- All other components (BlogList, BlogManager, UserManagement, Dashboard, etc.) remain here ---
        // ... (The rest of the components from the previous version are unchanged) ...
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
